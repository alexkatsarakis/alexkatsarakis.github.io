export default {
    name: 'Films',
    svgIcon: '<svg class="inventory-window-tabs-item-icon" height="448pt" viewBox="-69 0 448 448.00446" width="448pt" xmlns="http://www.w3.org/2000/svg"><path d="m283.429688 45.714844h-73.140626v-18.285156c0-15.125-12.304687-27.429688-27.429687-27.429688h-54.855469c-15.125 0-27.429687 12.304688-27.429687 27.429688v18.285156h-73.144531c-15.125 0-27.42578175 12.304687-27.42578175 27.429687v45.710938h18.28515575v301.71875c0 15.125 12.300782 27.429687 27.425782 27.429687h219.429687c15.125 0 27.429688-12.304687 27.429688-27.429687v-301.71875h18.285156v-45.710938c0-15.125-12.304687-27.429687-27.429687-27.429687zm-164.570313-18.285156c0-5.042969 4.097656-9.144532 9.144531-9.144532h54.855469c5.046875 0 9.144531 4.101563 9.144531 9.144532v18.285156h-73.144531zm155.429687 393.144531c0 5.046875-4.097656 9.144531-9.144531 9.144531h-219.429687c-5.042969 0-9.140625-4.097656-9.140625-9.144531v-301.71875h237.714843zm18.285157-320.003907h-274.285157v-27.425781c0-5.042969 4.097657-9.144531 9.140626-9.144531h256c5.046874 0 9.144531 4.101562 9.144531 9.144531zm0 0"/><path d="m210.289062 384.003906c5.054688 0 9.140626-4.089844 9.140626-9.140625v-201.148437c0-5.050782-4.085938-9.144532-9.140626-9.144532-5.054687 0-9.144531 4.09375-9.144531 9.144532v201.148437c0 5.050781 4.089844 9.140625 9.144531 9.140625zm0 0"/><path d="m155.429688 384.003906c5.054687 0 9.144531-4.089844 9.144531-9.140625v-201.148437c0-5.050782-4.089844-9.144532-9.144531-9.144532-5.050782 0-9.140626 4.09375-9.140626 9.144532v201.148437c0 5.050781 4.089844 9.140625 9.140626 9.140625zm0 0"/><path d="m100.574219 384.003906c5.054687 0 9.140625-4.089844 9.140625-9.140625v-201.148437c0-5.050782-4.085938-9.144532-9.140625-9.144532-5.054688 0-9.144531 4.09375-9.144531 9.144532v201.148437c0 5.050781 4.089843 9.140625 9.144531 9.140625zm0 0"/></svg>',
    svgIcon: '<svg class="inventory-window-tabs-item-icon" enable-background="new 0 0 511.999 511.999" height="512" viewBox="0 0 511.999 511.999" width="512" xmlns="http://www.w3.org/2000/svg"><g><g><path d="m398.082 323.343-18.295-18.295c7.834-1.736 13.714-8.728 13.714-17.076 0-26.883-18.546-49.508-43.514-55.771 9.461-12.911 16.232-27.691 19.74-43.362l3.164-1.46c12.739-5.88 19.001-20.354 14.563-33.665l-9.78-29.343c-1.719-5.157-4.866-9.524-8.9-12.756-5.942-22.816-18.487-42.994-36.386-58.532-1.615-11.773-4.355-20.755-6.98-23.979-3.413-4.189-10.368-7.802-37.208-6.21-9.333-11.075-21.744-22.894-32.2-22.894s-22.866 11.819-32.198 22.893c-26.843-1.597-33.796 2.021-37.208 6.211-2.641 3.244-5.385 12.227-6.999 23.995-17.893 15.539-30.426 35.705-36.364 58.511-4.037 3.233-7.185 7.602-8.906 12.761l-9.78 29.342c-4.438 13.312 1.824 27.785 14.564 33.665l3.245 1.498c3.578 15.613 10.418 30.342 19.968 43.246-3.093.756-6.127 1.758-9.081 3.032-3.804 1.641-5.557 6.054-3.916 9.857 1.224 2.835 3.987 4.531 6.891 4.531.991 0 1.999-.198 2.967-.615 4.672-2.015 9.609-3.156 14.704-3.403 2.723 2.719 5.57 5.329 8.567 7.79 3.782 3.105 7.738 5.947 11.831 8.534l-8.327 28.624h-49.958c-1.379 0-2.5-1.122-2.5-2.5 0-7.937 2.2-15.676 6.362-22.381 2.185-3.519 1.103-8.143-2.416-10.328-3.521-2.185-8.145-1.104-10.328 2.417-5.638 9.082-8.618 19.557-8.618 30.292 0 8.348 5.88 15.338 13.712 17.075l-18.295 18.296c-14.621 14.621-14.621 38.412 0 53.033 7.312 7.312 16.913 10.966 26.517 10.966 9.602 0 19.206-3.656 26.517-10.966l10.835-10.835-18.063 102.442c-1.739 9.864.467 19.816 6.212 28.021 5.728 8.18 14.291 13.649 24.119 15.405.03.006.061.011.092.017 2.191.386 4.371.573 6.524.573 17.846-.002 33.71-12.824 36.912-30.992l13.93-78.995c.728-4.127 4.298-7.122 8.488-7.122s7.761 2.995 8.488 7.123l13.932 78.994c3.204 18.17 19.065 30.992 36.913 30.992 2.151 0 4.333-.187 6.524-.573.023-.004.047-.008.07-.013 9.837-1.752 18.408-7.223 24.141-15.409 5.745-8.206 7.951-18.157 6.211-28.021-.719-4.079-4.612-6.807-8.688-6.083-4.079.719-6.803 4.609-6.083 8.688 1.044 5.918-.28 11.889-3.727 16.812s-8.605 8.209-14.524 9.252c-.018.003-.035.006-.053.01-12.201 2.121-23.861-6.062-26.013-18.261l-7.688-43.593 44.318-7.815 2.49 14.119c.642 3.639 3.806 6.199 7.377 6.199.433 0 .871-.038 1.312-.115 4.079-.72 6.803-4.609 6.083-8.688l-3.792-21.504c-.012-.066-.024-.133-.037-.198l-9.04-51.265 10.835 10.834c7.311 7.311 16.914 10.966 26.517 10.966s19.206-3.655 26.517-10.966c14.62-14.62 14.62-38.411-.001-53.032zm-19.582-35.371c0 1.378-1.121 2.5-2.5 2.5h-49.959l-8.246-28.344c4.628-2.891 9.074-6.096 13.275-9.636 2.614-2.203 5.119-4.52 7.518-6.933 22.234 1.343 39.912 19.848 39.912 42.413zm-27.327-182.405h-20.683c2.273-9.78 3.243-20.018 3.321-29.744 7.463 8.86 13.323 18.879 17.362 29.744zm-124.572-67.456c2.443.177 4.841-.859 6.385-2.776 12.22-15.172 20.788-20.252 23.006-20.335 2.235.083 10.804 5.163 23.023 20.335 1.544 1.917 3.945 2.954 6.385 2.776 20.335-1.48 26.837.18 28.479.799 2.946 6.521 8.992 38.322 1.151 66.657h-118.059c-7.846-28.335-1.811-60.117 1.149-66.657 1.644-.619 8.145-2.281 28.481-.799zm-48.424 37.725c.083 9.718 1.055 19.95 3.33 29.731h-20.684c4.037-10.86 9.895-20.873 17.354-29.731zm-39.401 82.621 9.78-29.342c1.704-5.112 6.47-8.547 11.858-8.547h191.17c5.389 0 10.154 3.435 11.858 8.547l9.78 29.342c2.017 6.051-.829 12.63-6.619 15.303l-96.985 44.762c-8.653 3.995-18.582 3.996-27.239 0l-96.983-44.762c-5.791-2.674-8.637-9.252-6.62-15.303zm21.647 38.758 75.671 34.925c6.326 2.92 13.115 4.379 19.906 4.379 6.789 0 13.581-1.46 19.905-4.379l75.863-35.013c-13.942 39.376-51.511 67.109-94.222 67.745-.482.007-.965.011-1.446.011-42.613 0-81.284-28.072-95.677-67.668zm95.66 82.668c.562 0 1.124-.004 1.686-.013 16.133-.24 31.98-3.883 46.514-10.493l15.673 53.877c.615 2.114-.43 4.355-2.429 5.213-9.943 4.267-31.159 11.423-61.528 11.423s-51.585-7.157-61.528-11.423c-1.999-.858-3.044-3.1-2.429-5.214l15.726-54.06c15.13 6.99 31.614 10.69 48.315 10.69zm-99.74 85.887c-8.771 8.772-23.047 8.772-31.818 0-8.773-8.773-8.773-23.047 0-31.82l28.477-28.478h28.592l-3.954 13.591c-2.033 6.989.059 14.303 4.961 19.167l-.274 1.556zm62.467 112.633c-2.149 12.192-13.796 20.375-25.995 18.263-.023-.004-.047-.008-.069-.013-5.919-1.043-11.077-4.329-14.524-9.252s-4.771-10.894-3.728-16.812l7.687-43.593 44.317 7.814zm60.449-78.996c-1.994-11.309-11.776-19.518-23.26-19.518s-21.266 8.208-23.26 19.518l-3.638 20.629-44.317-7.814 11.787-66.848c13.721 4.861 33.592 9.515 59.427 9.515s45.706-4.654 59.427-9.516l11.787 66.848-44.316 7.815zm108.215-33.637c-8.771 8.772-23.047 8.772-31.818 0l-25.984-25.983-.274-1.556c4.902-4.864 6.995-12.178 4.961-19.167l-3.954-13.591h28.592l28.478 28.478c8.773 8.772 8.773 23.046-.001 31.819z"/><path d="m256 198.54c4.143 0 7.5-3.358 7.5-7.5v-40c0-4.142-3.357-7.5-7.5-7.5s-7.5 3.358-7.5 7.5v40c0 4.142 3.357 7.5 7.5 7.5z"/><path d="m296 178.54c4.143 0 7.5-3.358 7.5-7.5v-20c0-4.142-3.357-7.5-7.5-7.5s-7.5 3.358-7.5 7.5v20c0 4.142 3.357 7.5 7.5 7.5z"/><path d="m216 178.54c4.143 0 7.5-3.358 7.5-7.5v-20c0-4.142-3.357-7.5-7.5-7.5s-7.5 3.358-7.5 7.5v20c0 4.142 3.357 7.5 7.5 7.5z"/></g></g></svg>',
    callback: showFilms,
    clear: removeAllAnimators
}

import Engine from '../../../Engine.js'
import uiFactory from '../../../utils/UIFactory.js'
import bb from '../../../utils/blackboard.js'

const FRAnimator = Engine.AnimationManager.getAnimatorCategory('FrameRangeAnimator');
const FRAnimation = Engine.AnimationManager.getAnimationCategory('FrameRangeAnimation');

const animatorsForPreview = [];

function removeAllAnimators(){
    animatorsForPreview.forEach((an)=>an());
}

function createPopUp(film, {id,delay = 90,dx = 0, dy = 0,reps = -1} = {delay: 90,dx: 0, dy: 0,reps: -1}){
    const wrap = document.createElement('div');
    wrap.id = 'animationWorkshopCreateWrapper';
    document.body.appendChild(wrap);

    const popUpCloseBack = document.createElement('div');
    popUpCloseBack.id = 'animationWorkshopCreate_popup_close_back';
    wrap.appendChild(popUpCloseBack);

    const popUp = document.createElement('div');
    popUp.id = 'animationWorkshopCreate_popup';
    wrap.appendChild(popUp);

    const toolbar = document.createElement('div');
    toolbar.id = 'animationWorkshopCreate_popup_toolbar';
    toolbar.innerHTML = 'Animation Workshop';
    popUp.appendChild(toolbar);

    const popUpClose = document.createElement('div');
    popUpClose.id = 'animationWorkshopCreate_popup_close';
    popUpClose.innerHTML = 'X';
    toolbar.appendChild(popUpClose);

    const mainArea = document.createElement('div');
    mainArea.id = 'animationWorkshopCreate_popup_mainarea';
    popUp.appendChild(mainArea);

    const mainAreaCanvas = document.createElement('canvas');
    mainAreaCanvas.id = 'animationWorkshopCreate_popup_mainarea_canvas';
    mainArea.appendChild(mainAreaCanvas);

    const filmArea = document.createElement('div');
    filmArea.id = 'animationWorkshopCreate_popup_filmarea';
    popUp.appendChild(filmArea);

    
    for(let i = 0; i < film.totalFrames; ++i){
        const box = film.getFrameBox(i);
        const preview = document.createElement('canvas');
        const width = filmArea.offsetWidth-2;
        preview.style.width = width;
        preview.style.height = width;
        preview.classList = 'animationWorkshopCreate_popup_filmarea_box';
        const previewCtx = preview.getContext('2d');
        previewCtx.canvas.width = width;
        previewCtx.canvas.height = width;
        previewCtx.drawImage(bb.fastGet('assets',film.bitmap),
        box.x,box.y,box.width,box.height,
        0, 0, width*(box.width/box.height), width);


        filmArea.appendChild(preview);
    }




    const editArea = document.createElement('div');
    editArea.id = 'animationWorkshopCreate_popup_editarea';
    popUp.appendChild(editArea);

    const delayWrapper = document.createElement('div');
    delayWrapper.classList += 'animationWorkshopCreate_popup_editarea_wrap';
    editArea.appendChild(delayWrapper);

    const delaySliderPrompt = document.createElement('div');
    delaySliderPrompt.innerHTML = 'Delay: ';
    delaySliderPrompt.classList += 'animationWorkshopCreate_popup_editarea_prompt';
    delayWrapper.appendChild(delaySliderPrompt);

    const delaySlider = document.createElement('input');
    delaySlider.type = 'range';
    delaySlider.id = 'animationWorkshopCreate_popup_editarea_delaySlider';
    delaySlider.min = '20';
    delaySlider.max = '200';
    delaySlider.step = '1';
    delaySlider.value = delay;
    delaySlider.classList += 'animationWorkshopCreate_popup_editarea_value';
    delayWrapper.appendChild(delaySlider);

    const dxWrapper = document.createElement('div');
    dxWrapper.classList += 'animationWorkshopCreate_popup_editarea_wrap';
    editArea.appendChild(dxWrapper);

    const dxPrompt = document.createElement('div');
    dxPrompt.innerHTML = 'Dx: ';
    dxPrompt.classList += 'animationWorkshopCreate_popup_editarea_prompt';
    dxWrapper.appendChild(dxPrompt);

    const dxInput = document.createElement('input');
    dxInput.type = 'number';
    dxInput.min = '-50';
    dxInput.max = '50';
    dxInput.step = '1';
    dxInput.value = dx;
    dxWrapper.appendChild(dxInput);    
    
    const dyWrapper = document.createElement('div');
    dyWrapper.classList += 'animationWorkshopCreate_popup_editarea_wrap';
    editArea.appendChild(dyWrapper);

    const dyPrompt = document.createElement('div');
    dyPrompt.innerHTML = 'Dy: ';
    dyPrompt.classList += 'animationWorkshopCreate_popup_editarea_prompt';
    dyWrapper.appendChild(dyPrompt);

    const dyInput = document.createElement('input');
    dyInput.type = 'number';
    dyInput.min = '-50';
    dyInput.max = '50';
    dyInput.step = '1';
    dyInput.value = dy;
    dyWrapper.appendChild(dyInput);

    const repsWrapper = document.createElement('div');
    repsWrapper.classList += 'animationWorkshopCreate_popup_editarea_wrap';
    editArea.appendChild(repsWrapper);

    const repsPrompt = document.createElement('div');
    repsPrompt.innerHTML = 'Repetitions: ';
    repsPrompt.classList += 'animationWorkshopCreate_popup_editarea_prompt';
    repsWrapper.appendChild(repsPrompt);

    const repsInput = document.createElement('input');
    repsInput.type = 'number';
    repsInput.min = '-1';
    repsInput.max = '100';
    repsInput.step = '1';
    repsInput.value = reps;
    repsWrapper.appendChild(repsInput);

    const idWrapper = document.createElement('div');
    idWrapper.classList += 'animationWorkshopCreate_popup_editarea_wrap';
    editArea.appendChild(idWrapper);

    const idPrompt = document.createElement('div');
    idPrompt.innerHTML = 'Animation ID: ';
    idPrompt.classList += 'animationWorkshopCreate_popup_editarea_prompt';
    idWrapper.appendChild(idPrompt);

    const idInput = document.createElement('input');
    idInput.type = 'text';
    idInput.classList = 'animationWorkshopCreate_popup_editarea_value';
    idInput.placeholder = 'my animation';
    idWrapper.appendChild(idInput);

    const startAnim = document.createElement('div');
    startAnim.classList = 'animationWorkshopCreate_popup_editarea_button';
    startAnim.innerHTML = 'Reset Position';
    editArea.appendChild(startAnim);

    const replayAnim = document.createElement('div');
    replayAnim.classList = 'animationWorkshopCreate_popup_editarea_button';
    replayAnim.innerHTML = 'Replay Animation';
    editArea.appendChild(replayAnim);

    const createAnim = document.createElement('div');
    createAnim.classList = 'animationWorkshopCreate_popup_editarea_button';
    createAnim.innerHTML = (id)?'Update Animation':'Create Animation';
    editArea.appendChild(createAnim);

    let animator = new FRAnimator();
    let animation = new FRAnimation({
        id: '_prevCreate',
        start: 0,
        end: film.totalFrames - 1,
        dx: Number.parseInt(dxInput.value),
        dy: Number.parseInt(dyInput.value),
        reps: Number.parseInt(repsInput.value),
        delay: Number.parseInt(delaySlider.value)
    });
    const ctx = mainAreaCanvas.getContext('2d');
    ctx.width = mainAreaCanvas.offsetWidth;
    ctx.height = mainAreaCanvas.offsetHeight;
    let firstBox = film.getFrameBox(0);
    let currPos = {
        x:(mainAreaCanvas.width/2) - ((firstBox.width/firstBox.height)*(mainAreaCanvas.height/3)/2),
        y:(mainAreaCanvas.height/2) - ((mainAreaCanvas.height/3)/2)
    };

    animator.onAction = (th)=>{
        firstBox = film.getFrameBox(th.currentFrame);
        currPos.x += th.animation.dx;
        currPos.y += th.animation.dy;
        if(currPos.x > mainAreaCanvas.width)
            currPos.x = -firstBox.width;
        else if(currPos.x + firstBox.width < 0)
            currPos.x = mainAreaCanvas.width-firstBox.width;
        if(currPos.y > mainAreaCanvas.height)
            currPos.y = -firstBox.height;
        else if(currPos.y + firstBox.height < 0)
            currPos.y = mainAreaCanvas.height-firstBox.height;
        ctx.clearRect(0,0,mainAreaCanvas.width,mainAreaCanvas.height);
        ctx.drawImage(bb.fastGet('assets',film.bitmap),
            firstBox.x,firstBox.y,firstBox.width,firstBox.height,
            currPos.x ,
            currPos.y ,
            (firstBox.width/firstBox.height)*(mainAreaCanvas.height/3),
            (mainAreaCanvas.height/3)
        )
    };
    // anim.height*(firstBox.width/firstBox.height), anim.height
    animator.start({
        animation: animation,
        timestamp: bb.fastGet('state','gameTime'),
    });

    function destroyPopUP(){
        animator.stop();
        wrap.remove();
    }

    function restartAnimation(){
        if(!animator.hasFinished())animator.stop();
        animation = new FRAnimation({
            id: '_prevCreate',
            start: 0,
            end: film.totalFrames - 1,
            dx: Number.parseInt(dxInput.value),
            dy: Number.parseInt(dyInput.value),
            reps: Number.parseInt(repsInput.value),
            delay: Number.parseInt(delaySlider.value)
        });
        animator.start({
            animation: animation,
            timestamp: bb.fastGet('state','gameTime'),
        });
    }

    function saveAnimation(){
        if(idInput.value !== ""){
            Engine.AnimationManager.registerNewAnimation(new FRAnimation({
                id: idInput.value,
                start: 0,
                end: film.totalFrames - 1,
                dx: Number.parseInt(dxInput.value),
                dy: Number.parseInt(dyInput.value),
                reps: Number.parseInt(repsInput.value),
                delay: Number.parseInt(delaySlider.value)
            }),film.id);
            destroyPopUP();
        }
    }

    dxInput.addEventListener('change',restartAnimation);
    dyInput.addEventListener('change',restartAnimation);
    repsInput.addEventListener('change',restartAnimation);
    delaySlider.addEventListener('change',restartAnimation);
    startAnim.addEventListener('click',()=>{
        currPos = {
            x:(mainAreaCanvas.width/2) - ((firstBox.width/firstBox.height)*(mainAreaCanvas.height/3)/2),
            y:(mainAreaCanvas.height/2) - ((mainAreaCanvas.height/3)/2)
        };
    });
    createAnim.addEventListener('click',saveAnimation);
    replayAnim.addEventListener('click',()=>{
        currPos = {
            x:(mainAreaCanvas.width/2) - ((firstBox.width/firstBox.height)*(mainAreaCanvas.height/3)/2),
            y:(mainAreaCanvas.height/2) - ((mainAreaCanvas.height/3)/2)
        };
        restartAnimation();
    });
    popUpClose.addEventListener('click',destroyPopUP);
    popUpCloseBack.addEventListener('click',destroyPopUP);

}

function showFilms(objWrapper){
    const items = Engine.AnimationManager.getAllFilms();
    objWrapper.innerHTML = '';

    const pageSwapWrap = uiFactory.createElement({
        parent: objWrapper,
        classList: 'inventory-window-body-page-swap'
    });

    objWrapper = uiFactory.createElement({
        classList: 'inventory-window-body-grid',
        parent: objWrapper
    });

    const itemsPerPage = 18;

    const keys = Object.keys(items);
    const pages = Math.ceil((keys.length-1) / itemsPerPage);
    let currPage = 1;

    
    function currFilmsShowing(){
        
        const starting = (currPage - 1) * itemsPerPage;
        let ending = (currPage) * itemsPerPage;
        if(ending > (keys.length)) ending = keys.length;
        pageSwapWrap.innerHTML = '';
        for(let i = 1; i <= pages; ++i){
            uiFactory.createElement({
                parent: pageSwapWrap,
                classList: 'inventory-window-body-page-item' + 
                ((Number.parseInt(currPage) === i)?
                    ' inventory-window-body-page-item-current':
                    ''),
                innerHTML: i
            }).onclick = (ev) => {
                objWrapper.innerHTML = '';
                currPage = ev.target.innerHTML;
                removeAllAnimators();
                currFilmsShowing();
            };
        }

        for(let j = starting; j < ending; ++j){
            const i = keys[j];
            const wrap = uiFactory.createElement({
                classList: 'inventory-window-animationPreview_itemWrapper',
                parent: objWrapper
            });
            const popuplistener = wrap.addEventListener('click',()=>{
                createPopUp(items[i]);
            });
    
            uiFactory.createElement({
                classList: 'inventory-window-animationPreview_objName',
                innerHTML: i,
                parent: wrap
            });
    
            const body = uiFactory.createElement({
                classList: 'inventory-window-animationPreview_body',
                parent: wrap
            });
    
            const anim = uiFactory.createElement({
                type: 'canvas',
                classList: 'inventory-window-animationPreview_film',
                parent: body
            });
            const ctx = anim.getContext('2d');
            ctx.canvas.width = anim.offsetWidth;
            ctx.canvas.height = anim.offsetHeight;

            const animator = new FRAnimator();
            const animation = new FRAnimation({
                id: '_prev_'+i,
                start: 0,
                end: items[i].totalFrames - 1,
                reps: -1,
                delay: 100
            });
    
            animator.onAction = (th)=>{
                const firstBox = items[i].getFrameBox(th.currentFrame);
                ctx.clearRect(0,0,anim.width,anim.height);
                ctx.drawImage(bb.fastGet('assets',items[i].bitmap),
                    firstBox.x,firstBox.y,firstBox.width,firstBox.height,
                    0,0,anim.height*(firstBox.width/firstBox.height), anim.height);
            };
    
            
        
            animator.start({
                animation: animation,
                timestamp: bb.fastGet('state','gameTime'),
            });
    
    
            animatorsForPreview.push(()=>{
                animator.stop();
                wrap.removeEventListener('click',popuplistener);
            });
        }
    }

    currFilmsShowing();
}